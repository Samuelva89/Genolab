## Render Deployment Configuration for Genolab with PostgreSQL and PostgREST
##
## This file defines the services that will be deployed to Render with PostgreSQL database
## and PostgREST for REST API layer.
## The configuration includes:
## - Web service for the FastAPI backend
## - PostgreSQL database for persistent data
## - PostgREST service for automatic REST API
## - Redis instance for Celery task queue
## - Environment variables configuration
---
services:
# Main web application service
- type: web
  name: genolab-api-postgres
  env: python
  region: frankfurt  # Choose region closest to your users
  plan: starter       # Scale as needed: free -> starter -> standard -> pro
  branch: main
  # Create runtime.txt to specify Python version
  buildCommand: |
    echo "python-3.11.10" > runtime.txt && \
    cd services && \
    pip install --upgrade pip && \
    pip install -r requirements.txt
  startCommand: cd services && python create_db.py && PYTHONPATH=/opt/render/project/src/services:$PYTHONPATH gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app -b 0.0.0.0:$PORT --timeout 120
  healthCheckPath: /api/health
  envVars:
    - key: PYTHON_PATH
      value: /opt/render/project/src/services
    - key: DEBUG
      value: False
    - key: TESTING
      value: False
    # PostgreSQL database configuration - Render will provide these automatically
    - key: SQLALCHEMY_DATABASE_URL
      fromDatabase:
        name: genolab-postgres-db
        property: connectionString
    # Redis configuration - Render will provide this automatically
    - key: REDIS_URL
      fromService:
        name: genolab-redis
        type: redis
        property: connectionString
    # MinIO/S3 compatible storage - you'll need to provide these externally
    - key: MINIO_ENDPOINT
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_ACCESS_KEY
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_SECRET_KEY
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_BUCKET_NAME
      value: genolab-bucket
    # PostgREST configuration
    - key: POSTGREST_URL
      fromService:
        name: genolab-postgrest
        type: web
        property: publicURL
    # Security settings
    - key: SECRET_KEY
      sync: false  # Generate a secure random key for production
    - key: ALGORITHM
      value: HS256
    - key: ACCESS_TOKEN_EXPIRE_MINUTES
      value: 30
    # Application settings
    - key: MAX_UPLOAD_SIZE_MB
      value: 10
    - key: ALLOWED_EXTENSIONS
      value: fasta,fastq,gb,gff,fa,fq

# PostgreSQL database service
- type: pserv
  name: genolab-postgres-db
  env: postgresql
  region: frankfurt
  plan: free    # Free tier available, upgrade as needed
  diskSizeGB: 10
  envVars:
    - key: POSTGRES_DB
      value: genolab_db
    - key: POSTGRES_USER
      value: genolab_user
    - key: POSTGRES_PASSWORD
      sync: false  # Set securely in Render dashboard

# PostgREST service
- type: web
  name: genolab-postgrest
  env: docker
  region: frankfurt
  plan: starter
  repo: https://github.com/PostgREST/postgrest
  branch: main  # Or specific release tag
  buildCommand: ""  # Using official PostgREST Docker image
  startCommand: "postgrest postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(PG_HOST):$(PG_PORT)/$(POSTGRES_DB) --schema public --anonymous anon --jwt-secret '$(JWT_SECRET)'"
  envVars:
    - key: PG_HOST
      fromDatabase:
        name: genolab-postgres-db
        property: host
    - key: PG_PORT
      fromDatabase:
        name: genolab-postgres-db
        property: port
    - key: POSTGRES_DB
      fromDatabase:
        name: genolab-postgres-db
        property: database
    - key: POSTGRES_USER
      fromDatabase:
        name: genolab-postgres-db
        property: user
    - key: POSTGRES_PASSWORD
      fromDatabase:
        name: genolab-postgres-db
        property: password
    - key: JWT_SECRET
      sync: false  # Set to the same SECRET_KEY as FastAPI app
    - key: DB_ANON_ROLE
      value: anon

# Redis service for Celery
- type: pserv
  name: genolab-redis
  env: redis
  region: frankfurt
  plan: free    # Free tier available, upgrade as needed
  maxmemoryPolicy: allkeys-lru  # Evict least recently used keys when memory is full