## Render Deployment Configuration for Genolab
##
## This file defines the services that will be deployed to Render.
## The configuration includes:
## - Web service for the FastAPI backend
## - PostgreSQL database for persistent data
## - Redis instance for Celery task queue
## - Environment variables configuration
---
services:
# Main web application service
- type: web
  name: genolab-api
  env: python
  region: frankfurt  # Choose region closest to your users
  plan: starter       # Scale as needed: free -> starter -> standard -> pro
  branch: main
  buildCommand: |
    cd services && \
    pip install -r requirements.txt
  startCommand: cd services && python start_server.py
  healthCheckPath: /api/health
  envVars:
    - key: DEBUG
      value: False
    - key: TESTING
      value: False
    - key: PORT
      value: 10000
    # Database configuration - Render will provide these automatically
    - key: SQLALCHEMY_DATABASE_URL
      fromDatabase:
        name: genolab-db
        property: connectionString
    # Redis configuration - Render will provide this automatically
    - key: REDIS_URL
      fromService:
        name: genolab-redis
        type: redis
        property: connectionString
    # MinIO/S3 compatible storage - you'll need to provide these externally
    - key: MINIO_ENDPOINT
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_ACCESS_KEY
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_SECRET_KEY
      sync: false  # This will be added manually in Render dashboard
    - key: MINIO_BUCKET_NAME
      value: genolab-bucket
    # Security settings
    - key: SECRET_KEY
      sync: false  # Generate a secure random key for production
    - key: ALGORITHM
      value: HS256
    - key: ACCESS_TOKEN_EXPIRE_MINUTES
      value: 30
    # Application settings
    - key: MAX_UPLOAD_SIZE_MB
      value: 10
    - key: ALLOWED_EXTENSIONS
      value: fasta,fastq,gb,gff,fa,fq

# Database service
- type: pserv
  name: genolab-db
  env: postgresql
  region: frankfurt
  plan: free    # Free tier available, upgrade as needed
  diskSizeGB: 10
  envVars:
    - key: POSTGRES_DB
      value: genolab_db
    - key: POSTGRES_USER
      value: genolab_user
    - key: POSTGRES_PASSWORD
      sync: false  # Set securely in Render dashboard

# Redis service for Celery
- type: pserv
  name: genolab-redis
  env: redis
  region: frankfurt
  plan: free    # Free tier available, upgrade as needed
  maxmemoryPolicy: allkeys-lru  # Evict least recently used keys when memory is full

# TODO: Celery worker service configuration (to be added later)
# - type: pserv  # This could be a background worker
#   name: genolab-celery-worker
#   env: python
#   region: frankfurt
#   plan: starter
#   branch: main
#   buildCommand: |
#     cd services && \
#     pip install -r requirements.txt
#   startCommand: celery -A app.celery_worker.celery_app worker --loglevel=info
#   envVars:
#     # Same environment variables as main web service